"use strict";!function(){var n=angular.module("account",["ngRoute","cookiesModule","senecaSettingsModule","angularFileUpload","jm.i18next"]);n.config(["$routeProvider","$i18nextProvider",function(n,e){n.when("/Applications",{tab:"Applications"}).when("/Settings",{tab:"Settings"}).when("/Account",{tab:"Account"}).otherwise({tab:"Applications"}),e.options={useCookie:!1,useLocalStorage:!1,resGetPath:"../locales/__lng__/__ns__.json"}}]);var e={unknown:"msg.unknown","user-updated":"msg.user-updated","user-exists-email":"msg.user-exists-email","user-exists-nick":"msg.user-exists-nick","password-updated":"msg.password-updated","org-updated":"msg.org-updated","application-updated":"msg.application-updated","application-deleted":"msg.application-deleted","token-deleted":"msg.token-deleted","only-images-allowed":"msg.only-images-allowed"};n.service("auth",["$http","$window",function(n,e){return{instance:function(e,o){n({method:"GET",url:"/auth/instance",cache:!1}).success(function(n){return e?e(n):void 0}).error(function(n){return o?o(n):void 0})},logout:function(o,i){n({method:"POST",url:"/auth/logout",cache:!1}).success(function(n){return o?o(n):e.location.href="/"}).error(function(n){return i?i(n):void 0})},change_password:function(e,o,i){n({method:"POST",url:"/auth/change_password",data:e,cache:!1}).success(function(n){return o?o(n):void 0}).error(function(n){return i?i(n):void 0})},update_user:function(e,o,i){n({method:"POST",url:"/auth/update_user",data:e,cache:!1}).success(function(n){return o?o(n):void 0}).error(function(n){return i?i(n):void 0})},update_org:function(e,o,i){n({method:"POST",url:"/account/update",data:e,cache:!1}).success(function(n){return o?o(n):void 0}).error(function(n){return i?i(n):void 0})}}}]),n.service("api",["$http","$window",function(n){return{get:function(n,e,o){this.call("GET",n,null,null,e,o)},post:function(n,e,o,i){this.call("POST",n,e,null,o,i)},del:function(n,e,o){this.call("DELETE",n,null,null,e,o)},call:function(e,o,i,t,s,a){var r={method:e,url:o,data:i,cache:!1};n(r).success(function(n){return s?s(n):void 0}).error(function(n){return a?a(n):void 0})}}}]),n.service("pubsub",function(){var n={};return{publish:function(e,o){n[e]&&$.each(n[e],function(){this.apply(null,o||[])})},subscribe:function(e,o){return n[e]||(n[e]=[]),n[e].push(o),[e,o]},unsubscribe:function(e){var o=e[0];n[o]&&d.each(n[o],function(i){this==e[1]&&n[o].splice(i,1)})}}}),n.controller("Main",["$scope","auth","pubsub",function(n,e,o){n.application_msg="blank",n.details_msg="blank",n.password_msg="blank",e.instance(function(e){n.user=e.user,n.account=e.account,o.publish("user",[e.user]),o.publish("account",[e.account])}),o.subscribe("user",function(e){n.user=e})}]),n.controller("NavBar",["$scope","auth","pubsub",function(n,e,o){n.btn_applications=function(){o.publish("view",["Applications"])},n.btn_account=function(){o.publish("view",["Account"])},n.btn_signout=function(){e.logout()}}]),n.controller("Account",["$scope","auth","pubsub","$upload",function(n,o,i,t){function s(){return{name:n.field_name,email:n.field_email,gravatar:n.field_gravatar,image:n.imageUrl}}function a(){return{password:n.field_password,repeat:n.field_repeat}}function r(){return{name:n.field_org_name,web:n.field_org_web}}i.subscribe("view",function(n){}),i.subscribe("user",function(e){n.field_name=e.name,n.field_email=e.email,n.field_gravatar=e.gravatar,n.imageUrl=e.image}),i.subscribe("account",function(e){n.field_org_name=e.name,n.field_org_web=e.web}),n.update_user=function(){var t=s();o.update_user(t,function(o){n.details_msg=e["user-updated"],i.publish("user",[o.user])},function(o){n.details_msg=e[o.why]||e.unknown})},n.change_pass=function(){var i=a();o.change_password(i,function(){n.password_msg=e["password-updated"]},function(o){n.password_msg=e[o.why]||e.unknown})},n.update_org=function(){var t=r();o.update_org(t,function(o){n.org_msg=e["org-updated"],i.publish("account",[o.account])},function(o){n.org_msg=e[o.why]||e.unknown})},n.onFileSelect=function(o){for(var i=0;i<o.length;i++){var s=o[i],a=["jpeg","jpg","png","gif","bmp"];if(-1==$.inArray(s.name.split(".").pop().toLowerCase(),a))return void alert(e["only-images-allowed"]);n.upload=t.upload({url:"/upload",file:s}).progress(function(n){console.log("percent: "+parseInt(100*n.loaded/n.total))}).success(function(e){n.imageUrl=e.url}).error(function(){alert("Upload failed")})}}}]),n.controller("TabView",["$scope","$route","$location","pubsub",function(n,e,o,i){var t=["Dashboard","Applications","Settings","Account"];n.views=_.filter(t,function(n){return"Account"!=n}),i.subscribe("view",function(e){console.log("fired:"+e),_.each(t,function(o){n["show_view_"+o]=e==o}),n.curtab=e,o.path(e)}),n.tabview=function(n){i.publish("view",[n])},n.$on("$routeChangeSuccess",function(e,o){o.tab&&n.curtab!=o.tab&&n.tabview(o.tab)})}]),n.directive("imageUrl",function(){return{restrict:"A",link:function(n,e){e.val(n.imageUrl),e.data("old-value",n.imageUrl),n.$watch("imageUrl",function(){e.val(n.imageUrl)}),e.bind("onchange propertychange keyup paste",function(){e.data("old-value")!=e.val()&&n.$apply(function(){n.imageUrl=e.val(),e.data("old-value",e.val())})})}}}),n.controller("Applications",["$scope","api","pubsub","$upload",function(n,o,i,t){function s(){a(),r()}function a(){o.get("/api/rest/application?account="+n.account.id,function(e){n.applications=e})}function r(){o.get("/api/user/token",function(e){n.tokens=e.tokens})}function c(){return{account:n.account.id,name:n.field_name,appid:n.appid,secret:n.secret,homeurl:n.field_homeurl,callback:n.field_callback,desc:n.field_desc,image:n.imageUrl}}n.applications=[],n.show_applications_list=!0,n.show_application_details=!1,n.new_application=function(){n.open_application()},n.open_application=function(e){void 0!=e?o.get("/api/rest/application/"+e,function(e){n.show_application(e)}):n.show_application()},n.show_application=function(e){n.application=e=e||{},n.field_name=e.name,n.field_homeurl=e.homeurl,n.field_callback=e.callback,n.field_desc=e.desc,n.appid=e.appid,n.secret=e.secret,n.imageUrl=e.image,n.show_applications_list=!1,n.show_application_details=!0,n.application_msg="blank"},n.close_application=function(){n.show_applications_list=!0,n.show_application_details=!1},n.save_application=function(){n.application=_.extend(n.application,c()),o.post("/api/rest/application",n.application,function(o){n.show_application(o),n.application_msg=e["application-updated"],i.publish("application.change",[o])},function(o){n.application_msg=e[o.why]||e.unknown})},n.delete_application=function(t){confirm("Are you sure?")&&o.del("/api/rest/application/"+t,function(){n.application_msg=e["application-deleted"],i.publish("application.change",[])},function(o){n.application_msg=e[o.why]||e.unknown})},n.revoke_token=function(t){confirm("Are you sure?")&&o.del("/api/user/token?access_token="+t,function(){i.publish("application.change",[])},function(o){n.token_msg=e[o.why]||e.unknown})},n.onFileSelect=function(o){for(var i=0;i<o.length;i++){var s=o[i],a=["jpeg","jpg","png","gif","bmp"];if(-1==$.inArray(s.name.split(".").pop().toLowerCase(),a))return void alert(e["only-images-allowed"]);n.upload=t.upload({url:"/upload",file:s}).progress(function(n){console.log("percent: "+parseInt(100*n.loaded/n.total))}).success(function(e){n.imageUrl=e.url}).error(function(){alert("Upload failed")})}},s(),i.subscribe("application.change",s)}])}(),angular.module("services.config",[]).constant("configuration",{signup_enabled:!0});var cookiesModule=angular.module("cookiesModule",[]);cookiesModule.constant("infinity_date","Fri, 31 Dec 9999 23:59:59 GMT"),cookiesModule.factory("Cookies",["infinity_date",function(n){return{getItem:function(n){return decodeURI(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURI(n).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,o,i,t,s,a){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;var r="";if(i)switch(i.constructor){case Number:r=1/0===i?"; expires="+n:"; max-age="+i;break;case String:r="; expires="+i;break;case Date:r="; expires="+i.toGMTString()}return document.cookie=encodeURI(e)+"="+encodeURI(o)+r+(s?"; domain="+s:"")+(t?"; path="+t:"")+(a?"; secure":""),!0},removeItem:function(n,e){return n&&this.hasItem(n)?(document.cookie=encodeURI(n)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(e?"; path="+e:""),!0):!1},hasItem:function(n){return new RegExp("(?:^|;\\s*)"+encodeURI(n).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var n=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),e=0;e<n.length;e++)n[e]=decodeURI(n[e]);return n}}}]),i18n.init({resGetPath:"/locales/__lng__/__ns__.json"},function(){$(".container").i18n()}),function(){function n(n){return null==n||0==""+n}var e=angular.module("home",["cookiesModule","services.config","angularFileUpload","jm.i18next"]);e.config(["$i18nextProvider",function(n){n.options={useCookie:!1,useLocalStorage:!1,resGetPath:"../locales/__lng__/__ns__.json"}}]),e.controller("Main",["$scope","$location","configuration",function(n,e,o){var i=window.location.pathname,t=!0,s=0==i.indexOf("/signup"),a=0==i.indexOf("/forgot"),r=0==i.indexOf("/reset"),c=0==i.indexOf("/confirm");return s&&!o.signup_enabled?window.location.href="/":(t=!(s||a||c||r),n.show_login=t,n.show_signup=s,n.show_forgot=a,n.show_reset=r,n.show_confirm=c,void(n.msg="blank"))}]);var o={unknown:"msg.unknown","missing-fields":"msg.missing-fields","user-not-found":"msg.user-not-found","invalid-password":"msg.invalid-password","mismatch-password":"msg.mismatch-password","email-exists":"msg.email-exists","nick-exists":"msg.nick-exists","reset-sent":"msg.reset-sent","activate-reset":"msg.activate-reset","invalid-reset":"msg.invalid-reset","reset-done":"msg.reset-done",confirmed:"msg.confirmed","invalid-confirm-code":"msg.invalid-confirm-code","only-images-allowed":"msg.only-images-allowed"};e.service("auth",["$http","$window",function(n,e){return{login:function(o,i,t){n({method:"POST",url:"/auth/login",data:o,cache:!1}).success(function(n){return i?i(n):e.location.href="/account"}).error(function(n){return t?t(n):void 0})},register:function(o,i,t){n({method:"POST",url:"/auth/register",data:o,cache:!1}).success(function(n){return i?i(n):e.location.href="/account"}).error(function(n){return t?t(n):void 0})},instance:function(e,o){n({method:"GET",url:"/auth/instance",cache:!1}).success(function(n){return e?e(n):void 0}).error(function(n){return o?o(n):void 0})},reset:function(e,o,i){n({method:"POST",url:"/auth/create_reset",data:e,cache:!1}).success(function(n){return o?o(n):void 0}).error(function(n){return i?i(n):void 0})},reset_load:function(e,o,i){n({method:"POST",url:"/auth/load_reset",data:e,cache:!1}).success(function(n){return o?o(n):void 0}).error(function(n){return i?i(n):void 0})},reset_execute:function(e,o,i){n({method:"POST",url:"/auth/execute_reset",data:e,cache:!1}).success(function(n){return o?o(n):void 0}).error(function(n){return i?i(n):void 0})},confirm:function(e,o,i){n({method:"POST",url:"/auth/confirm",data:e,cache:!1}).success(function(n){return o?o(n):void 0}).error(function(n){return i?i(n):void 0})}}}]),e.controller("Login",["$scope","$rootScope","auth","configuration",function(e,i,t,s){function a(){return{email:!n(e.input_email),password:!n(e.input_password)}}function r(n,o){_.each(n,function(n,i){o&&o[i]||(e["seek_"+i]=!n)}),e.seek_signin=!n.email||!n.password,e.seek_send=!n.email}function c(){t.login({email:e.input_email,password:e.input_password},null,function(n){e.msg=o[n.why]||o.unknown,e.showmsg=!0,"user-not-found"==n.why&&(e.seek_email=!0),"invalid-password"==n.why&&(e.seek_password=!0)})}function u(){t.reset({email:e.input_email},function(){e.cancel(),e.msg=o["reset-sent"],e.showmsg=!0},function(n){e.msg=o[n.why]||o.unknown,e.showmsg=!0,"user-not-found"==n.why&&(e.seek_email=!0)})}e.signup_enabled=s.signup_enabled,e.signin=function(){e.showmsg=!1;var n=a();r(n,{}),n.email&&n.password?c():(e.msg=o["missing-fields"],e.showmsg=!0),e.signin_hit=!0,e.mode="signin"},e.send=function(){"send"!=e.mode&&show({name:!1,password:!1,signup:!1,signin:!1,cancel:!0,send:!0}),e.send_hit=!0,e.showmsg=!1;var n=a();n.email?u():r(n),e.mode="send"},e.forgot=function(){window.location.href="/forgot"},e.goaccount=function(){window.location.href="/account"},e.signup=function(){window.location.href="/signup"},e.user=null,e.showmsg=!1,e.signin_hit=!1,e.input_email="",e.input_password="",e.$watch("input_email",function(){e.seek_email=!1}),e.$watch("input_password",function(){e.seek_password=!1}),e.seek_email=!1,e.seek_password=!1,e.hasuser=!!e.user,t.instance(function(n){e.user=n.user,e.hasuser=!!e.user,i.$emit("instance",{user:n.user})})}]),e.controller("Signup",["$scope","$rootScope","auth","$upload",function(e,i,t,s){function a(){return{name:!n(e.input_name),email:!n(e.input_email),password:!n(e.input_password),verify_password:!n(e.input_verify_password)}}function r(n,o){_.each(n,function(n,i){o&&o[i]||(e["seek_"+i]=!n)}),e.seek_signup=!n.email||!n.password,e.seek_send=!n.email}function c(){t.register({name:e.input_name,email:e.input_email,password:e.input_password,image:e.imageUrl,gravatar:e.input_gravatar},null,function(n){e.msg=o[n.why]||o.unknown,"email-exists"==n.why&&(e.seek_email=!0),"nick-exists"==n.why&&(e.seek_email=!0),e.showmsg=!0})}t.instance(function(n){n.user&&(e.show_signup=!1,window.location.href="/account")}),e.signup=function(){e.showmsg=!1;var n=a();r(n),n.name&&n.email&&n.password&&n.verify_password?e.input_password==e.input_verify_password?c():(e.msg=o["mismatch-password"],e.showmsg=!0):(e.msg=o["missing-fields"],e.showmsg=!0),e.signup_hit=!0,e.mode="signup"},e.onFileSelect=function(n){for(var i=0;i<n.length;i++){var t=n[i],a=["jpeg","jpg","png","gif","bmp"];if(-1==$.inArray(t.name.split(".").pop().toLowerCase(),a))return void alert(o["only-images-allowed"]);e.upload=s.upload({url:"/upload",file:t}).progress(function(n){console.log("percent: "+parseInt(100*n.loaded/n.total))}).success(function(n){e.imageUrl=n.url}).error(function(){alert("Upload failed")})}},e.showmsg=!1,e.signup_hit=!1,e.input_email="",e.input_password="",e.input_verify_password="",e.input_gravatar="",e.$watch("input_email",function(){e.seek_email=!1}),e.$watch("input_password",function(){e.seek_password=!1}),e.$watch("input_verify_password",function(){e.seek_verify_password=!1}),e.$watch("input_gravatar",function(){e.seek_gravatar=!1}),e.seek_email=!1,e.seek_password=!1,e.seek_verify_password=!1,e.seek_gravatar=!1}]),e.controller("Forgot",["$scope","$rootScope","auth",function(e,i,t){function s(){return{email:!n(e.input_email)}}function a(n,o){_.each(n,function(n,i){o&&o[i]||(e["seek_"+i]=!n)}),e.seek_forgot=!n.email,e.seek_send=!n.email}function r(){t.reset({email:e.input_email},function(){e.msg=o["reset-sent"],e.showmsg=!0},function(n){e.msg=o[n.why]||o.unknown,e.showmsg=!0,"user-not-found"==n.why&&(e.seek_email=!0)})}t.instance(function(n){n.user&&(e.show_forgot=!1,window.location.href="/account")}),e.forgot=function(){e.showmsg=!1;var n=s();a(n),n.email?r():(e.msg=o["missing-fields"],e.showmsg=!0),e.forgot_hit=!0,e.mode="forgot"},e.showmsg=!1,e.forgot_hit=!1,e.input_email="",e.$watch("input_email",function(){e.seek_email=!1}),e.seek_email=!1}]),e.controller("Reset",["$scope","$http","auth",function(e,i,t){if(e.show_reset){e.show_resetpass=!0,e.show_gohome=!1;var s=window.location.pathname,a=s.replace(/^\/reset\//,"");t.reset_load({token:a},function(n){e.msg=o["activate-reset"],e.nick=n.nick,e.show_reset=!0},function(){e.msg=o["invalid-reset"]}),e.reset=function(){e.seek_password=n(e.input_password),e.seek_repeat=n(e.input_repeat),e.seek_reset=e.seek_password||e.seek_repeat,e.seek_password||e.seek_repeat?e.msg=o["missing-fields"]:t.reset_execute({token:a,password:e.input_password,repeat:e.input_repeat},function(){e.msg=o["reset-done"],e.show_gohome=!0,e.show_resetpass=!1},function(){e.msg=o["invalid-reset"]})},e.gohome=function(){window.location.href="/"},e.goaccount=function(){window.location.href="/account"}}}]),e.controller("Confirm",["$scope","$rootScope","auth",function(n,e,i){if(n.show_confirm){e.$on("instance",function(e,o){n.show_goaccount=!!o.user,n.show_gohome=!o.user});var t=window.location.pathname,s=t.replace(/^\/confirm\//,"");i.confirm({code:s},function(){n.msg=o.confirmed},function(){n.msg=o["invalid-confirm-code"]}),n.gohome=function(){window.location.href="/"},n.goaccount=function(){window.location.href="/account"}}}])}();