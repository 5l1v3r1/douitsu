"use strict";!function(){var e=angular.module("account",["ngRoute","cookiesModule","senecaSettingsModule"]);e.config(["$routeProvider",function(e){e.when("/Applications",{tab:"Applications"}).when("/Settings",{tab:"Settings"}).when("/Account",{tab:"Account"}).otherwise({tab:"Applications"})}]);var n={unknown:"Unable to perform your request at this time - please try again later.","user-updated":"Your user details have been updated.","user-exists-email":"A user with that email already exists.","user-exists-nick":"A user with that username already exists.","password-updated":"Your password has been updated.","org-updated":"Your organisations details have been updated.","application-updated":"Application updated.","application-deleted":"Application deleted.","token-deleted":"Token deleted."};e.service("auth",["$http","$window",function(e,n){return{instance:function(n,t){e({method:"GET",url:"/auth/instance",cache:!1}).success(function(e){return n?n(e):void 0}).error(function(e){return t?t(e):void 0})},logout:function(t,i){e({method:"POST",url:"/auth/logout",cache:!1}).success(function(e){return t?t(e):n.location.href="/"}).error(function(e){return i?i(e):void 0})},change_password:function(n,t,i){e({method:"POST",url:"/auth/change_password",data:n,cache:!1}).success(function(e){return t?t(e):void 0}).error(function(e){return i?i(e):void 0})},update_user:function(n,t,i){e({method:"POST",url:"/auth/update_user",data:n,cache:!1}).success(function(e){return t?t(e):void 0}).error(function(e){return i?i(e):void 0})},update_org:function(n,t,i){e({method:"POST",url:"/account/update",data:n,cache:!1}).success(function(e){return t?t(e):void 0}).error(function(e){return i?i(e):void 0})}}}]),e.service("api",["$http","$window",function(e){return{get:function(e,n,t){this.call("GET",e,null,null,n,t)},post:function(e,n,t,i){this.call("POST",e,n,null,t,i)},del:function(e,n,t){this.call("DELETE",e,null,null,n,t)},call:function(n,t,i,o,a,s){var r={method:n,url:t,data:i,cache:!1};e(r).success(function(e){return a?a(e):void 0}).error(function(e){return s?s(e):void 0})}}}]),e.service("pubsub",function(){var e={};return{publish:function(n,t){e[n]&&$.each(e[n],function(){this.apply(null,t||[])})},subscribe:function(n,t){return e[n]||(e[n]=[]),e[n].push(t),[n,t]},unsubscribe:function(n){var t=n[0];e[t]&&d.each(e[t],function(i){this==n[1]&&e[t].splice(i,1)})}}}),e.controller("Main",["$scope","auth","pubsub",function(e,n,t){n.instance(function(n){e.user=n.user,e.account=n.account,t.publish("user",[n.user]),t.publish("account",[n.account])}),t.subscribe("user",function(n){e.user=n})}]),e.controller("NavBar",["$scope","auth","pubsub",function(e,n,t){e.btn_applications=function(){t.publish("view",["Applications"])},e.btn_account=function(){t.publish("view",["Account"])},e.btn_signout=function(){n.logout()}}]),e.controller("Account",["$scope","auth","pubsub",function(e,t,i){function o(){return{name:e.field_name,email:e.field_email,gravatar:e.field_gravatar,image:e.imageUrl}}function a(){return{password:e.field_password,repeat:e.field_repeat}}function s(){return{name:e.field_org_name,web:e.field_org_web}}i.subscribe("view",function(e){}),i.subscribe("user",function(n){e.field_name=n.name,e.field_email=n.email,e.field_gravatar=n.gravatar,e.field_image=n.image}),i.subscribe("account",function(n){e.field_org_name=n.name,e.field_org_web=n.web}),e.update_user=function(){var a=o();t.update_user(a,function(t){e.details_msg=n["user-updated"],i.publish("user",[t.user])},function(t){e.details_msg=n[t.why]||n.unknown})},e.change_pass=function(){var i=a();t.change_password(i,function(){e.password_msg=n["password-updated"]},function(t){e.password_msg=n[t.why]||n.unknown})},e.update_org=function(){var o=s();t.update_org(o,function(t){e.org_msg=n["org-updated"],i.publish("account",[t.account])},function(t){e.org_msg=n[t.why]||n.unknown})}}]),e.controller("TabView",["$scope","$route","$location","pubsub",function(e,n,t,i){var o=["Dashboard","Applications","Settings","Account"];e.views=_.filter(o,function(e){return"Account"!=e}),i.subscribe("view",function(n){console.log("fired:"+n),_.each(o,function(t){e["show_view_"+t]=n==t}),e.curtab=n,t.path(n)}),e.tabview=function(e){i.publish("view",[e])},e.$on("$routeChangeSuccess",function(n,t){t.tab&&e.curtab!=t.tab&&e.tabview(t.tab)})}]),e.directive("imageUrl",function(){return{restrict:"A",link:function(e,n){n.val(e.imageUrl),n.data("old-value",e.imageUrl),e.$watch("imageUrl",function(){n.val(e.imageUrl)}),n.bind("onchange propertychange keyup paste",function(){n.data("old-value")!=n.val()&&e.$apply(function(){e.imageUrl=n.val(),n.data("old-value",n.val())})})}}}),e.controller("Applications",["$scope","api","pubsub",function(e,t,i){function o(){a(),s()}function a(){t.get("/api/rest/application?account="+e.account.id,function(n){e.applications=n})}function s(){t.get("/api/user/token",function(n){e.tokens=n.tokens})}function r(){return{account:e.account.id,name:e.field_name,appid:e.appid,secret:e.secret,homeurl:e.field_homeurl,callback:e.field_callback,desc:e.field_desc,image:e.imageUrl}}e.applications=[],e.show_applications_list=!0,e.show_application_details=!1,e.new_application=function(){e.open_application()},e.open_application=function(n){void 0!=n?t.get("/api/rest/application/"+n,function(n){e.show_application(n)}):e.show_application()},e.show_application=function(n){e.application=n=n||{},e.field_name=n.name,e.field_homeurl=n.homeurl,e.field_callback=n.callback,e.field_desc=n.desc,e.appid=n.appid,e.secret=n.secret,e.show_applications_list=!1,e.show_application_details=!0,e.application_msg=null},e.close_application=function(){e.show_applications_list=!0,e.show_application_details=!1},e.save_application=function(){e.application=_.extend(e.application,r()),t.post("/api/rest/application",e.application,function(t){e.show_application(t),e.application_msg=n["application-updated"],i.publish("application.change",[t])},function(t){e.application_msg=n[t.why]||n.unknown})},e.delete_application=function(o){confirm("Are you sure?")&&t.del("/api/rest/application/"+o,function(){e.application_msg=n["application-deleted"],i.publish("application.change",[])},function(t){e.application_msg=n[t.why]||n.unknown})},e.revoke_token=function(o){confirm("Are you sure?")&&t.del("/api/user/token?access_token="+o,function(){i.publish("application.change",[])},function(t){e.token_msg=n[t.why]||n.unknown})},o(),i.subscribe("application.change",o)}])}(),angular.module("services.config",[]).constant("configuration",{signup_enabled:!0});var cookiesModule=angular.module("cookiesModule",[]);cookiesModule.constant("infinity_date","Fri, 31 Dec 9999 23:59:59 GMT"),cookiesModule.factory("Cookies",["infinity_date",function(e){return{getItem:function(e){return decodeURI(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURI(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(n,t,i,o,a,s){if(!n||/^(?:expires|max\-age|path|domain|secure)$/i.test(n))return!1;var r="";if(i)switch(i.constructor){case Number:r=1/0===i?"; expires="+e:"; max-age="+i;break;case String:r="; expires="+i;break;case Date:r="; expires="+i.toGMTString()}return document.cookie=encodeURI(n)+"="+encodeURI(t)+r+(a?"; domain="+a:"")+(o?"; path="+o:"")+(s?"; secure":""),!0},removeItem:function(e,n){return e&&this.hasItem(e)?(document.cookie=encodeURI(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(n?"; path="+n:""),!0):!1},hasItem:function(e){return new RegExp("(?:^|;\\s*)"+encodeURI(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),n=0;n<e.length;n++)e[n]=decodeURI(e[n]);return e}}}]),function(){function e(e){return null==e||0==""+e}var n=angular.module("home",["cookiesModule","services.config"]);n.controller("Main",["$scope","$location","configuration",function(e,n,t){var i=window.location.pathname,o=!0,a=0==i.indexOf("/signup"),s=0==i.indexOf("/forgot"),r=0==i.indexOf("/reset"),c=0==i.indexOf("/confirm");return a&&!t.signup_enabled?window.location.href="/":(o=!(a||s||c||r),e.show_login=o,e.show_signup=a,e.show_forgot=s,e.show_reset=r,void(e.show_confirm=c))}]);var t={unknown:"Unable to perform your request at this time - please try again later.","missing-fields":"Please enter the missing fields.","user-not-found":"That email address is not recognized.","invalid-password":"That password is incorrect","mismatch-password":"Password mismatch","email-exists":"That email address is already in use. Please login, or ask for a password reset.","nick-exists":"That email address is already in use. Please login, or ask for a password reset.","reset-sent":"An email with password reset instructions has been sent to you.","activate-reset":"Please enter your new password.","invalid-reset":"This is not a valid reset.","reset-done":"Your password has been reset.",confirmed:"Your account has been confirmed","invalid-confirm-code":"That confirmation code is not valid."};n.service("auth",["$http","$window",function(e,n){return{login:function(t,i,o){e({method:"POST",url:"/auth/login",data:t,cache:!1}).success(function(e){return i?i(e):n.location.href="/account"}).error(function(e){return o?o(e):void 0})},register:function(t,i,o){e({method:"POST",url:"/auth/register",data:t,cache:!1}).success(function(e){return i?i(e):n.location.href="/account"}).error(function(e){return o?o(e):void 0})},instance:function(n,t){e({method:"GET",url:"/auth/instance",cache:!1}).success(function(e){return n?n(e):void 0}).error(function(e){return t?t(e):void 0})},reset:function(n,t,i){e({method:"POST",url:"/auth/create_reset",data:n,cache:!1}).success(function(e){return t?t(e):void 0}).error(function(e){return i?i(e):void 0})},reset_load:function(n,t,i){e({method:"POST",url:"/auth/load_reset",data:n,cache:!1}).success(function(e){return t?t(e):void 0}).error(function(e){return i?i(e):void 0})},reset_execute:function(n,t,i){e({method:"POST",url:"/auth/execute_reset",data:n,cache:!1}).success(function(e){return t?t(e):void 0}).error(function(e){return i?i(e):void 0})},confirm:function(n,t,i){e({method:"POST",url:"/auth/confirm",data:n,cache:!1}).success(function(e){return t?t(e):void 0}).error(function(e){return i?i(e):void 0})}}}]),n.controller("Login",["$scope","$rootScope","auth","configuration",function(n,i,o,a){function s(){return{email:!e(n.input_email),password:!e(n.input_password)}}function r(e,t){_.each(e,function(e,i){t&&t[i]||(n["seek_"+i]=!e)}),n.seek_signin=!e.email||!e.password,n.seek_send=!e.email}function c(){o.login({email:n.input_email,password:n.input_password},null,function(e){n.msg=t[e.why]||t.unknown,n.showmsg=!0,"user-not-found"==e.why&&(n.seek_email=!0),"invalid-password"==e.why&&(n.seek_password=!0)})}function u(){o.reset({email:n.input_email},function(){n.cancel(),n.msg=t["reset-sent"],n.showmsg=!0},function(e){n.msg=t[e.why]||t.unknown,n.showmsg=!0,"user-not-found"==e.why&&(n.seek_email=!0)})}n.signup_enabled=a.signup_enabled,n.signin=function(){n.showmsg=!1;var e=s();r(e,{}),e.email&&e.password?c():(n.msg=t["missing-fields"],n.showmsg=!0),n.signin_hit=!0,n.mode="signin"},n.send=function(){"send"!=n.mode&&show({name:!1,password:!1,signup:!1,signin:!1,cancel:!0,send:!0}),n.send_hit=!0,n.showmsg=!1;var e=s();e.email?u():r(e),n.mode="send"},n.forgot=function(){window.location.href="/forgot"},n.goaccount=function(){window.location.href="/account"},n.signup=function(){window.location.href="/signup"},n.user=null,n.showmsg=!1,n.signin_hit=!1,n.input_email="",n.input_password="",n.$watch("input_email",function(){n.seek_email=!1}),n.$watch("input_password",function(){n.seek_password=!1}),n.seek_email=!1,n.seek_password=!1,n.hasuser=!!n.user,o.instance(function(e){n.user=e.user,n.hasuser=!!n.user,i.$emit("instance",{user:e.user})})}]),n.directive("imageUrl",function(){return{restrict:"A",link:function(e,n){n.val(e.imageUrl),n.data("old-value",e.imageUrl),e.$watch("imageUrl",function(){n.val(e.imageUrl)}),n.bind("onchange propertychange keyup paste",function(){n.data("old-value")!=n.val()&&e.$apply(function(){e.imageUrl=n.val(),n.data("old-value",n.val())})})}}}),n.controller("Signup",["$scope","$rootScope","auth",function(n,i,o){function a(){return{name:!e(n.input_name),email:!e(n.input_email),password:!e(n.input_password),verify_password:!e(n.input_verify_password)}}function s(e,t){_.each(e,function(e,i){t&&t[i]||(n["seek_"+i]=!e)}),n.seek_signup=!e.email||!e.password,n.seek_send=!e.email}function r(){o.register({name:n.input_name,email:n.input_email,password:n.input_password,image:n.imageUrl,gravatar:n.input_gravatar},null,function(e){n.msg=t[e.why]||t.unknown,"email-exists"==e.why&&(n.seek_email=!0),"nick-exists"==e.why&&(n.seek_email=!0),n.showmsg=!0})}o.instance(function(e){e.user&&(n.show_signup=!1,window.location.href="/account")}),n.signup=function(){n.showmsg=!1;var e=a();s(e),e.name&&e.email&&e.password&&e.verify_password?n.input_password==n.input_verify_password?r():(n.msg=t["mismatch-password"],n.showmsg=!0):(n.msg=t["missing-fields"],n.showmsg=!0),n.signup_hit=!0,n.mode="signup"},n.showmsg=!1,n.signup_hit=!1,n.input_email="",n.input_password="",n.input_verify_password="",n.input_gravatar="",n.$watch("input_email",function(){n.seek_email=!1}),n.$watch("input_password",function(){n.seek_password=!1}),n.$watch("input_verify_password",function(){n.seek_verify_password=!1}),n.$watch("input_gravatar",function(){n.seek_gravatar=!1}),n.seek_email=!1,n.seek_password=!1,n.seek_verify_password=!1,n.seek_gravatar=!1}]),n.controller("Forgot",["$scope","$rootScope","auth",function(n,i,o){function a(){return{email:!e(n.input_email)}}function s(e,t){_.each(e,function(e,i){t&&t[i]||(n["seek_"+i]=!e)}),n.seek_forgot=!e.email,n.seek_send=!e.email}function r(){o.reset({email:n.input_email},function(){n.msg=t["reset-sent"],n.showmsg=!0},function(e){n.msg=t[e.why]||t.unknown,n.showmsg=!0,"user-not-found"==e.why&&(n.seek_email=!0)})}o.instance(function(e){e.user&&(n.show_forgot=!1,window.location.href="/account")}),n.forgot=function(){n.showmsg=!1;var e=a();s(e),e.email?r():(n.msg=t["missing-fields"],n.showmsg=!0),n.forgot_hit=!0,n.mode="forgot"},n.showmsg=!1,n.forgot_hit=!1,n.input_email="",n.$watch("input_email",function(){n.seek_email=!1}),n.seek_email=!1}]),n.controller("Reset",["$scope","$http","auth",function(n,i,o){if(n.show_reset){n.show_resetpass=!0,n.show_gohome=!1;var a=window.location.pathname,s=a.replace(/^\/reset\//,"");o.reset_load({token:s},function(e){n.msg=t["activate-reset"],n.nick=e.nick,n.show_reset=!0},function(){n.msg=t["invalid-reset"]}),n.reset=function(){n.seek_password=e(n.input_password),n.seek_repeat=e(n.input_repeat),n.seek_reset=n.seek_password||n.seek_repeat,n.seek_password||n.seek_repeat?n.msg=t["missing-fields"]:o.reset_execute({token:s,password:n.input_password,repeat:n.input_repeat},function(){n.msg=t["reset-done"],n.show_gohome=!0,n.show_resetpass=!1},function(){n.msg=t["invalid-reset"]})},n.gohome=function(){window.location.href="/"},n.goaccount=function(){window.location.href="/account"}}}]),n.controller("Confirm",["$scope","$rootScope","auth",function(e,n,i){if(e.show_confirm){n.$on("instance",function(n,t){e.show_goaccount=!!t.user,e.show_gohome=!t.user});var o=window.location.pathname,a=o.replace(/^\/confirm\//,"");i.confirm({code:a},function(){e.msg=t.confirmed},function(){e.msg=t["invalid-confirm-code"]}),e.gohome=function(){window.location.href="/"},e.goaccount=function(){window.location.href="/account"}}}])}(),function(e,n){var t=n.document;e(t).ready(function(){var t,i,o,a,s,r=[],c=0,u=!1,l=0,p=0;s=function(e){e.stopPropagation(),e.preventDefault()},i=function(n){t=e(event.target).closest(".dropzone"),s(n);var i=n.dataTransfer.files,a=i.length;if(a>0){if(a>1)return void alert("Multiple files not supported");var c=i[0].name.split(".").pop();if(!c.toLowerCase().match("jpg|jpeg|png|gif"))return void alert("Unsupported file type");l=r.length,p+=a,u||(p-=a,r.push.apply(r,i),o())}},a=function(n){var i={};i.name=r[c].name,i.type=r[c].type,i.contents=n.target.result,t.find("#dropzoneLabel").html("Uploading..."),e.post("/upload",i,function(e,n,i){if(200==i.status){var a=JSON.parse(e).url;t.find("img").attr("src",a);var s=t.find("#field_image");s.val(a),s.trigger("propertychange")}else alett("Upload failed");r[c]=1,c++,o()})},o=function(){if(c<r.length){u=!0;var e=r[c],n=new FileReader;n.onload=a,n.readAsDataURL(e)}else u=!1},n.setTimeout(function(){e(".dropzone").each(function(){this.addEventListener("dragenter",s,!1),this.addEventListener("dragexit",s,!1),this.addEventListener("dragover",s,!1),this.addEventListener("drop",i,!1)})},200)})}(jQuery,window);