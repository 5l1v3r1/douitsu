"use strict";!function(){function e(e){return null==e||0==""+e}var n={unknown:"msg.unknown","missing-fields":"msg.missing-fields","invalid-email":"msg.invalid-email","invalid-url":"msg.invalid-url","mismatch-password":"msg.mismatch-password","user-updated":"msg.user-updated","user-exists-email":"msg.user-exists-email","user-exists-nick":"msg.user-exists-nick","password-updated":"msg.password-updated","org-updated":"msg.org-updated","application-updated":"msg.application-updated","application-deleted":"msg.application-deleted","token-deleted":"msg.token-deleted","only-images-allowed":"msg.only-images-allowed"},i=angular.module("accountControllers",["ngRoute","cookiesModule","configService","senecaSettingsModule","authService","apiService","pubsubService","fileUploadService","validatorService"]);i.controller("Main",["$scope","features","auth","pubsub",function(e,n,i,o){e.show_account=!0,n.account||(e.show_account=!1),e.application_msg="blank",e.details_msg="blank",e.password_msg="blank",i.instance(function(n){e.user=n.user,e.account=n.account,o.publish("user",[n.user]),o.publish("account",[n.account])}),o.subscribe("user",function(n){e.user=n})}]),i.controller("NavBar",["$scope","features","auth","pubsub",function(e,n,i,o){e.btn_applications=function(){o.publish("view",["Applications"])},n.account&&(e.btn_account=function(){o.publish("view",["Account"])}),e.btn_signout=function(){i.logout()}}]),i.controller("Account",["$scope","features","auth","pubsub","fileUpload","validator",function(i,o,a,t,s,u){function c(){return{name:!e(i.field_name),email:!e(i.field_email),email_valid:u.email(i.field_email)}}function r(e,n){_.each(e,function(e,o){n&&n[o]||(i["seek_"+o]=!e)}),e.email_valid||(i.seek_email=!0)}function l(){return{name:i.field_name,email:i.field_email,gravatar:i.field_gravatar,image:i.imageUrl}}function d(){return{password:i.field_password,repeat:i.field_repeat}}function p(){return{name:i.field_org_name,web:i.field_org_web}}o.account&&(t.subscribe("view",function(e){}),t.subscribe("user",function(e){i.field_name=e.name,i.field_email=e.email,i.field_gravatar=e.gravatar,i.imageUrl=e.image,i.email=e.email}),t.subscribe("account",function(e){i.field_org_name=e.name,i.field_org_web=e.web}),i.update_user=function(){var e=c();if(r(e),e.name&&e.email)if(e.email_valid){var o=l();i.email==o.email&&delete o.email,a.update_user(o,function(e){i.details_msg=n["user-updated"],t.publish("user",[e.user])},function(e){i.details_msg=n[e.why]||n.unknown})}else i.details_msg=n["invalid-email"];else i.details_msg=n["missing-fields"]},i.change_pass=function(){if(i.field_password==i.field_repeat){var e=d();a.change_password(e,function(){i.password_msg=n["password-updated"]},function(e){i.password_msg=n[e.why]||n.unknown})}else i.password_msg=n["mismatch-password"]},i.update_org=function(){var e=p();a.update_org(e,function(e){i.org_msg=n["org-updated"],t.publish("account",[e.account])},function(e){i.org_msg=n[e.why]||n.unknown})},i.onFileSelect=function(e){i.details_msg="blank";for(var o=0;o<e.length;o++){var a=e[o];s.isImage(a)?i.upload=s.upload(a,function(e){e?i.imageUrl=e.url:i.details_msg=n["upload-failed"]}):i.details_msg=n["only-images-allowed"]}})}]),i.controller("TabView",["$scope","$route","$location","pubsub",function(e,n,i,o){var a=["Dashboard","Applications","Settings","Account"];e.views=_.filter(a,function(e){return"Account"!=e}),o.subscribe("view",function(n){console.log("fired:"+n),_.each(a,function(i){e["show_view_"+i]=n==i}),e.curtab=n,i.path(n)}),e.tabview=function(e){o.publish("view",[e])},e.$on("$routeChangeSuccess",function(n,i){i.tab&&e.curtab!=i.tab&&e.tabview(i.tab)})}]),i.controller("Applications",["$scope","auth","api","pubsub","fileUpload","validator",function(i,o,a,t,s,u){function c(){r(),l()}function r(){o.instance(function(e){a.get("/api/rest/application?account="+e.account.id,function(e){i.applications=e})})}function l(){a.get("/api/user/application",function(e){i.user_applications=e.applications})}function d(){return{name:!e(i.field_name),homeurl:!e(i.field_homeurl),homeurl_valid:u.url(i.field_homeurl),callback:!e(i.field_callback),callback_valid:u.url(i.field_callback),desc:!e(i.field_desc)}}function p(e,n){_.each(e,function(e,o){n&&n[o]||(i["seek_"+o]=!e)}),e.homeurl_valid||(i.seek_homeurl=!0),e.callback_valid||(i.seek_callback=!0)}function f(){return{account:i.account.id,name:i.field_name,appid:i.appid,secret:i.secret,homeurl:i.field_homeurl,callback:i.field_callback,desc:i.field_desc,image:i.imageUrl}}i.applications=[],i.show_applications_list=!0,i.show_application_details=!1,i.new_application=function(){i.open_application()},i.open_application=function(e){void 0!=e?a.get("/api/rest/application/"+e,function(e){i.show_application(e)}):i.show_application()},i.show_application=function(e){i.application=e=e||{},i.field_name=e.name,i.field_homeurl=e.homeurl,i.field_callback=e.callback,i.field_desc=e.desc,i.appid=e.appid,i.secret=e.secret,i.imageUrl=e.image,i.show_applications_list=!1,i.show_application_details=!0,i.application_msg="blank"},i.close_application=function(){i.show_applications_list=!0,i.show_application_details=!1},i.save_application=function(){var e=d();p(e),e.name&&e.homeurl&&e.callback&&e.desc?e.homeurl_valid&&e.callback_valid?(i.application=_.extend(i.application,f()),a.post("/api/rest/application",i.application,function(e){i.show_application(e),i.application_msg=n["application-updated"],t.publish("application.change",[e])},function(e){i.application_msg=n[e.why]||n.unknown})):i.application_msg=n["invalid-url"]:i.application_msg=n["missing-fields"]},i.delete_application=function(e){confirm("Are you sure?")&&a.del("/api/rest/application/"+e,function(){i.application_msg=n["application-deleted"],t.publish("application.change",[])},function(e){i.application_msg=n[e.why]||n.unknown})},i.revoke_user_application=function(e){confirm("Are you sure?")&&a.del("/api/user/application/"+e,function(){t.publish("application.change",[])},function(e){i.token_msg=n[e.why]||n.unknown})},i.onFileSelect=function(e){i.application_msg="blank";for(var o=0;o<e.length;o++){var a=e[o];s.isImage(a)?i.upload=s.upload(a,function(e){e?i.imageUrl=e.url:i.application_msg=n["upload-failed"]}):i.application_msg=n["only-images-allowed"]}},c(),t.subscribe("application.change",c)}])}(),function(){var e=angular.module("account",["ngRoute","configService","accountControllers","i18nModule"]);e.config(["$routeProvider","features",function(e,n){e.when("/Applications",{tab:"Applications"}),e.when("/Settings",{tab:"Settings"}),n.account&&e.when("/Account",{tab:"Account"}),e.otherwise({tab:"Applications"})}])}(),function(){var e=angular.module("apiService",[]);e.service("api",["$http","$window",function(e){return{get:function(e,n,i){this.call("GET",e,null,null,n,i)},post:function(e,n,i,o){this.call("POST",e,n,null,i,o)},del:function(e,n,i){this.call("DELETE",e,null,null,n,i)},call:function(n,i,o,a,t,s){var u={method:n,url:i,data:o,cache:!1};e(u).success(function(e){return t?t(e):void 0}).error(function(e){return s?s(e):void 0})}}}])}(),function(){var e=angular.module("authService",[]);e.service("auth",["$http","$window",function(e,n){return{login:function(i,o,a){e({method:"POST",url:"/auth/login",data:i,cache:!1}).success(function(e){return o?o(e):n.location.href="/account"}).error(function(e){return a?a(e):void 0})},register:function(i,o,a){e({method:"POST",url:"/auth/register",data:i,cache:!1}).success(function(e){return o?o(e):n.location.href="/account"}).error(function(e){return a?a(e):void 0})},instance:function(n,i){e({method:"GET",url:"/auth/instance",cache:!1}).success(function(e){return n?n(e):void 0}).error(function(e){return i?i(e):void 0})},reset:function(n,i,o){e({method:"POST",url:"/auth/create_reset",data:n,cache:!1}).success(function(e){return i?i(e):void 0}).error(function(e){return o?o(e):void 0})},reset_load:function(n,i,o){e({method:"POST",url:"/auth/load_reset",data:n,cache:!1}).success(function(e){return i?i(e):void 0}).error(function(e){return o?o(e):void 0})},reset_execute:function(n,i,o){e({method:"POST",url:"/auth/execute_reset",data:n,cache:!1}).success(function(e){return i?i(e):void 0}).error(function(e){return o?o(e):void 0})},confirm:function(n,i,o){e({method:"POST",url:"/auth/confirm",data:n,cache:!1}).success(function(e){return i?i(e):void 0}).error(function(e){return o?o(e):void 0})},logout:function(i,o){e({method:"POST",url:"/auth/logout",cache:!1}).success(function(e){return i?i(e):n.location.href="/"}).error(function(e){return o?o(e):void 0})},change_password:function(n,i,o){e({method:"POST",url:"/auth/change_password",data:n,cache:!1}).success(function(e){return i?i(e):void 0}).error(function(e){return o?o(e):void 0})},update_user:function(n,i,o){e({method:"POST",url:"/auth/update_user",data:n,cache:!1}).success(function(e){return i?i(e):void 0}).error(function(e){return o?o(e):void 0})},update_org:function(n,i,o){e({method:"POST",url:"/account/update",data:n,cache:!1}).success(function(e){return i?i(e):void 0}).error(function(e){return o?o(e):void 0})}}}])}(),function(){angular.module("configService",[]).constant("features",features)}();var cookiesModule=angular.module("cookiesModule",[]);cookiesModule.constant("infinity_date","Fri, 31 Dec 9999 23:59:59 GMT"),cookiesModule.factory("Cookies",["infinity_date",function(e){return{getItem:function(e){return decodeURI(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURI(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(n,i,o,a,t,s){if(!n||/^(?:expires|max\-age|path|domain|secure)$/i.test(n))return!1;var u="";if(o)switch(o.constructor){case Number:u=1/0===o?"; expires="+e:"; max-age="+o;break;case String:u="; expires="+o;break;case Date:u="; expires="+o.toGMTString()}return document.cookie=encodeURI(n)+"="+encodeURI(i)+u+(t?"; domain="+t:"")+(a?"; path="+a:"")+(s?"; secure":""),!0},removeItem:function(e,n){return e&&this.hasItem(e)?(document.cookie=encodeURI(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(n?"; path="+n:""),!0):!1},hasItem:function(e){return new RegExp("(?:^|;\\s*)"+encodeURI(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),n=0;n<e.length;n++)e[n]=decodeURI(e[n]);return e}}}]),function(){var e=angular.module("fileUploadService",["angularFileUpload"]);e.service("fileUpload",["$upload",function(e){return{isImage:function(e){var n=["jpeg","jpg","png","gif","bmp"];return-1!=$.inArray(e.name.split(".").pop().toLowerCase(),n)},upload:function(n,i){return e.upload({url:"/upload",file:n}).progress(function(e){console.log("percent: "+parseInt(100*e.loaded/e.total))}).success(function(e){i(e)}).error(function(e){i(null,e)})}}}])}(),i18n.init({lng:languages[0],useCookie:!1,useLocalStorage:!1,resGetPath:"/locales/__lng__/__ns__.json",fallbackLng:"en"},function(){$(".container").i18n()}),function(){var e=angular.module("i18nModule",["jm.i18next"]);e.config(["$i18nextProvider",function(e){e.options={lng:languages[0],useCookie:!1,useLocalStorage:!1,resGetPath:"../locales/__lng__/__ns__.json",fallbackLng:"en"}}])}(),function(){var e=angular.module("pubsubService",[]);e.service("pubsub",["$http","$window",function(){var e={};return{publish:function(n,i){e[n]&&$.each(e[n],function(){this.apply(null,i||[])})},subscribe:function(n,i){return e[n]||(e[n]=[]),e[n].push(i),[n,i]},unsubscribe:function(n){var i=n[0];e[i]&&d.each(e[i],function(o){this==n[1]&&e[i].splice(o,1)})}}}])}(),function(){var e=angular.module("validatorService",[]);e.service("validator",function(){return{email:function(e){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)},url:function(e){return/^(https?):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)*(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(e)}}})}(),function(){function e(e){return null==e||0==""+e}var n={unknown:"msg.unknown","missing-fields":"msg.missing-fields","user-not-found":"msg.user-not-found","invalid-email":"msg.invalid-email","invalid-password":"msg.invalid-password","mismatch-password":"msg.mismatch-password","email-exists":"msg.email-exists","nick-exists":"msg.nick-exists","reset-sent":"msg.reset-sent","activate-reset":"msg.activate-reset","invalid-reset":"msg.invalid-reset","reset-done":"msg.reset-done",confirmed:"msg.confirmed","invalid-confirm-code":"msg.invalid-confirm-code","only-images-allowed":"msg.only-images-allowed"},i=angular.module("homeControllers",["cookiesModule","configService","authService","fileUploadService","angular-md5","validatorService"]);i.controller("Main",["$scope","$location","features",function(e,n,i){var o=window.location.pathname,a=!0,t=0==o.indexOf("/signup"),s=0==o.indexOf("/forgot"),u=0==o.indexOf("/reset"),c=0==o.indexOf("/confirm");return t&&!i.signup?window.location.href="/":(a=!(t||s||c||u),e.show_login=a,e.show_signup=t,e.show_forgot=s,e.show_reset=u,e.show_confirm=c,void(e.msg="blank"))}]),i.controller("Login",["$scope","$rootScope","auth","features",function(i,o,a,t){function s(){return{email:!e(i.input_email),password:!e(i.input_password)}}function u(e,n){_.each(e,function(e,o){n&&n[o]||(i["seek_"+o]=!e)}),i.seek_signin=!e.email||!e.password,i.seek_send=!e.email}function c(){a.login({email:i.input_email,password:i.input_password},null,function(e){i.msg=n[e.why]||n.unknown,i.showmsg=!0,"user-not-found"==e.why&&(i.seek_email=!0),"invalid-password"==e.why&&(i.seek_password=!0)})}function r(){a.reset({email:i.input_email},function(){i.cancel(),i.msg=n["reset-sent"],i.showmsg=!0},function(e){i.msg=n[e.why]||n.unknown,i.showmsg=!0,"user-not-found"==e.why&&(i.seek_email=!0)})}i.signup_enabled=t.signup,i.signin=function(){i.showmsg=!1;var e=s();u(e,{}),e.email&&e.password?c():(i.msg=n["missing-fields"],i.showmsg=!0),i.signin_hit=!0,i.mode="signin"},i.send=function(){"send"!=i.mode&&show({name:!1,password:!1,signup:!1,signin:!1,cancel:!0,send:!0}),i.send_hit=!0,i.showmsg=!1;var e=s();e.email?r():u(e),i.mode="send"},i.forgot=function(){window.location.href="/forgot"},i.goaccount=function(){window.location.href="/account"},i.signup=function(){window.location.href="/signup"},i.user=null,i.showmsg=!1,i.signin_hit=!1,i.input_email="",i.input_password="",i.$watch("input_email",function(){i.seek_email=!1}),i.$watch("input_password",function(){i.seek_password=!1}),i.seek_email=!1,i.seek_password=!1,i.hasuser=!!i.user,a.instance(function(e){i.user=e.user,i.hasuser=!!i.user,o.$emit("instance",{user:e.user})})}]),i.controller("Signup",["$scope","$rootScope","auth","fileUpload","features","md5","validator",function(i,o,a,t,s,u,c){function r(){return{name:!e(i.input_name),email:!e(i.input_email),email_valid:c.email(i.input_email),password:!e(i.input_password),verify_password:!e(i.input_verify_password)}}function l(e,n){_.each(e,function(e,o){n&&n[o]||(i["seek_"+o]=!e)}),e.email_valid||(i.seek_email=!0),i.seek_signup=!e.email||!e.password,i.seek_send=!e.email}function d(e){return s.gravatar?"http://www.gravatar.com/avatar/"+u.createHash(e.toLowerCase().trim())+"?d=blank&s=200":null}function p(){a.register({name:i.input_name,email:i.input_email,password:i.input_password,image:i.imageUrl||d(i.input_email),gravatar:i.input_gravatar},null,function(e){i.msg=n[e.why]||n.unknown,"email-exists"==e.why&&(i.seek_email=!0),"nick-exists"==e.why&&(i.seek_email=!0),i.showmsg=!0})}a.instance(function(e){e.user&&(i.show_signup=!1,window.location.href="/account")}),i.signup=function(){i.showmsg=!1;var e=r();l(e),e.name&&e.email&&e.password&&e.verify_password?e.email_valid&&i.input_password==i.input_verify_password?p():e.email_valid?(i.msg=n["mismatch-password"],i.showmsg=!0):(i.msg=n["invalid-email"],i.showmsg=!0):(i.msg=n["missing-fields"],i.showmsg=!0),i.signup_hit=!0,i.mode="signup"},i.onFileSelect=function(e){i.showmsg=!1;for(var o=0;o<e.length;o++){var a=e[o];t.isImage(a)?i.upload=t.upload(a,function(e){e?i.imageUrl=e.url:(i.msg=n["upload-failed"],i.showmsg=!0)}):(i.msg=n["only-images-allowed"],i.showmsg=!0)}},i.showmsg=!1,i.signup_hit=!1,i.input_email="",i.input_password="",i.input_verify_password="",i.input_gravatar="",i.$watch("input_email",function(){i.seek_email=!1}),i.$watch("input_password",function(){i.seek_password=!1}),i.$watch("input_verify_password",function(){i.seek_verify_password=!1}),i.$watch("input_gravatar",function(){i.seek_gravatar=!1}),i.seek_email=!1,i.seek_password=!1,i.seek_verify_password=!1,i.seek_gravatar=!1}]),i.controller("Forgot",["$scope","$rootScope","auth",function(i,o,a){function t(){return{email:!e(i.input_email)}}function s(e,n){_.each(e,function(e,o){n&&n[o]||(i["seek_"+o]=!e)}),i.seek_forgot=!e.email,i.seek_send=!e.email}function u(){a.reset({email:i.input_email},function(){i.msg=n["reset-sent"],i.showmsg=!0},function(e){i.msg=n[e.why]||n.unknown,i.showmsg=!0,"user-not-found"==e.why&&(i.seek_email=!0)})}a.instance(function(e){e.user&&(i.show_forgot=!1,window.location.href="/account")}),i.forgot=function(){i.showmsg=!1;var e=t();s(e),e.email?u():(i.msg=n["missing-fields"],i.showmsg=!0),i.forgot_hit=!0,i.mode="forgot"},i.showmsg=!1,i.forgot_hit=!1,i.input_email="",i.$watch("input_email",function(){i.seek_email=!1}),i.seek_email=!1}]),i.controller("Reset",["$scope","$http","auth",function(i,o,a){if(i.show_reset){i.show_resetpass=!0,i.show_gohome=!1;var t=window.location.pathname,s=t.replace(/^\/reset\//,"");a.reset_load({token:s},function(e){i.msg=n["activate-reset"],i.nick=e.nick,i.show_reset=!0},function(){i.msg=n["invalid-reset"]}),i.reset=function(){i.seek_password=e(i.input_password),i.seek_repeat=e(i.input_repeat),i.seek_reset=i.seek_password||i.seek_repeat,i.seek_password||i.seek_repeat?i.msg=n["missing-fields"]:a.reset_execute({token:s,password:i.input_password,repeat:i.input_repeat},function(){i.msg=n["reset-done"],i.show_gohome=!0,i.show_resetpass=!1},function(){i.msg=n["invalid-reset"]})},i.gohome=function(){window.location.href="/"},i.goaccount=function(){window.location.href="/account"}}}]),i.controller("Confirm",["$scope","$rootScope","auth",function(e,i,o){if(e.show_confirm){i.$on("instance",function(n,i){e.show_goaccount=!!i.user,e.show_gohome=!i.user});var a=window.location.pathname,t=a.replace(/^\/confirm\//,"");o.confirm({code:t},function(){e.msg=n.confirmed},function(){e.msg=n["invalid-confirm-code"]}),e.gohome=function(){window.location.href="/"},e.goaccount=function(){window.location.href="/account"}}}])}(),function(){angular.module("home",["homeControllers","i18nModule"])}();